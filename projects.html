<!DOCTYPE html>
<html lang = "en"> <!-- language flag, used by screen readers -->
<head>
  <meta charset = "uft-8" /> <!-- character set definition -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2, minimum-scale=0.5">

  <title>Josh Newland's projects</title>
  <!-- imports  CSS definitions with media queries-->
  <link rel= "stylesheet" href ="styles/shared.css">
  <link rel= "stylesheet" href ="styles/topBar.css">

</head>
<body>
  <canvas id="bgCanvas" class="fullFixed"></canvas>
  <canvas id="activeCanvas" class="fullFixed"></canvas>

  <div id="contentContainer">
    <div id="labelsContainer">
      <p id="headerLabel" >Projects</p>
      <p id="descriptionLabel" >Most of my small game projects can be found on <a href="https://gamejolt.com/@Jn327/games" target="_blank" >Game Jolt</a> & <a href="https://jn327.itch.io/" target="_blank" >Itch.io</a></p>
    </div>
  </div>

  <script src="scripts/Utils/Vector2d.js"></script>
  <script src="scripts/Utils/MathEx.js"></script>
  <script src="scripts/Utils/SimplexNoise.js"></script>
  <script src="scripts/Utils/EasingUtil.js"></script>

  <script src="scripts/GameLoop.js"></script>
  <script src="scripts/MouseTracker.js"></script>
  <script src="scripts/CanvasScaler.js"></script>

  <script src="scripts/Particle.js"></script>

  <script src="scripts/CommonElementsCreator.js"></script>
  <script> createHeaderElement(document.body, 1); </script>

  <script>
    //HTML Elements
    var bgCanvas, bgCtx;
    var activeCanvas, activeCtx;

    //noise
    var strNoiseScale = 0.002;
    var dirNoiseScale = 0.004;
    var hueNoiseScale = 0.0005;

    var vectorField;
    var vectorFieldMinStr     = 0.25;
    var vectorFieldMaxStr     = 1;
    var vectorFieldStrMultip  = 330;

    var pixelSizeX = 8;
    var pixelSizeY = 8;
    var lastPixelX;
    var lastPixelY;

    var nParticles    = 1750;
    var particleSize  = 2;
    var particles;

    var particleMouseAvoidanceDist  = 50;
    var particleMouseAvoidanceStr   = 200;

    var minHue        = 180;
    var maxHue        = 360;
    var theHue        = 0;
    var hueVariation  = 60;
    var theSaturation = 90; //0-100 (percent)

    var changeFrequency   = 20;
    var changeTimer       = 0;
    var fadeOutDur        = 1.25;
    var fadeOutTimer      = 0;
    var fadeInDur         = 0.75;
    var fadeInTimer       = 0;

    //------------------------------------------------
    //                Initialization
    //------------------------------------------------
    function start()
    {
      setRandomHue();

      initCanvas();
      initVectorField();
      initParticles();
    }

    function setRandomHue()
    {
      theHue = (minHue+(hueVariation*0.5)) + (Math.random() * ((maxHue-(minHue))-hueVariation));
    }

    function initCanvas()
    {
      bgCanvas  = document.getElementById("bgCanvas");
      bgCtx     = bgCanvas.getContext('2d');

      activeCanvas = document.getElementById("activeCanvas");
      activeCtx    = activeCanvas.getContext('2d');

      validateCanvasSize();
    }

    function validateCanvasSize()
    {
      var bTrue = false;

      if(CanvasScaler.updateCanvasSize( bgCanvas ))
      {
        bTrue = true;
      }
      if(CanvasScaler.updateCanvasSize( activeCanvas ))
      {
        bTrue = true;
      }

      return bTrue;
    }

    function initVectorField()
    {
      var strNoise = new SimplexNoise();
      var dirNoise = new SimplexNoise();
      var hueNoise = new SimplexNoise();

      vectorField = [];

      for ( var x = 0; x < bgCanvas.width; x += pixelSizeX )
      {
        lastPixelX = x;
        vectorField[x] = [];

        for ( var y = 0; y < bgCanvas.height; y+= pixelSizeY )
        {
          lastPixelY = y;

          var vectorStr = (strNoise.noise(x * strNoiseScale, y * strNoiseScale) + 1) * 0.5; //0-1
          vectorStr = Math.scaleNormal(vectorStr, vectorFieldMinStr, vectorFieldMaxStr);
          var vectorDir = (dirNoise.noise(x * dirNoiseScale, y * dirNoiseScale) + 1) * Math.PI;
          var hueValue = strNoise.noise(x * hueNoiseScale, y * hueNoiseScale); //-1 to 1

          var theVector = new Vector2D(Math.cos(vectorDir), Math.sin(vectorDir));
          theVector.multiply(vectorStr * vectorFieldStrMultip);
          vectorField[x][y] = theVector;

          // Background canvas
          var hueWithVar = theHue + (hueValue * hueVariation);
          bgCtx.fillStyle = 'hsla('+hueWithVar+','+theSaturation+'%,85%,1)';
          bgCtx.fillRect(x,y,pixelSizeX,pixelSizeY);

        }
      }
    }

    function initParticles()
    {
      particles = [];

      var particle;
      for ( var n = 0; n < nParticles; n++ )
      {
        particle = new Particle();
        setupParticle(particle);
        particles[n] = particle;
      }
    }

    function setupParticle(theParticle)
    {
      theParticle.position.x = Math.random() * lastPixelX;
      theParticle.position.y = Math.random() * lastPixelY;
      theParticle.size = particleSize;

      return theParticle;
    }

    function resetParticles()
    {
      for ( var n = 0; n < particles.length; n++ )
      {
        setupParticle(particles[n]);
      }
    }

    //------------------------------------------------
    //                    Update
    //------------------------------------------------
    function update()
    {
      if (validateCanvasSize() == true)
      {
        changeTimer = 0;
        fadeOutTimer = 0;

        resetBgCanvas();
        activeCtx.clearRect(0, 0, activeCanvas.width, activeCanvas.height);

        initVectorField();
        resetParticles();
      }
      else
      {
        changeTimer += GameLoop.deltaTime;
        if (changeTimer > changeFrequency)
        {
          if (fadeOutTimer < fadeOutDur)
          {
            fadeOutTimer += GameLoop.deltaTime;

            var endOpacity = EasingUtil.easeInQuad(fadeOutTimer, 1, -1, fadeOutDur);
            bgCanvas.style.opacity = endOpacity;
            activeCanvas.style.opacity = endOpacity;
          }
          else
          {
            changeTimer = 0;
            fadeOutTimer   = 0;

            setRandomHue();
            resetBgCanvas();

            //reset of the vector field after a while, keeps things interesting...
            initVectorField();
            resetParticles();
          }
        }

        if (fadeInTimer < fadeInDur)
        {
          fadeInTimer += GameLoop.deltaTime;

          var endOpacity = EasingUtil.easeInQuad(fadeInTimer, 0, 1, fadeInDur);
          endOpacity = Math.clamp(endOpacity, 0, 1);
          console.log(endOpacity);
          bgCanvas.style.opacity = endOpacity;
          activeCanvas.style.opacity = endOpacity;
        }
      }

      renderCanvas();
    }

    function resetBgCanvas()
    {
      bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
      bgCanvas.style.opacity = 0;
      activeCanvas.style.opacity = 0;
      fadeInTimer = 0;
    }

    function renderCanvas()
    {
      activeCtx.clearRect(0, 0, activeCanvas.width, activeCanvas.height);

      var particleHue = theHue; //(theHue+180) % 360;
      bgCtx.fillStyle = 'hsla('+particleHue+','+theSaturation+'%,98%,0.033)';

      var particle;
      var xPos;
      var yPos;
      for ( var n = 0; n < particles.length; n++ )
      {
        particle = particles[n];

        //Guard against null ref!
        xPos = Math.roundMultip(particle.position.x, pixelSizeX);
        yPos = Math.roundMultip(particle.position.y, pixelSizeY);

        if (xPos >= 0 && yPos >= 0
          && xPos <= lastPixelX && yPos <= lastPixelY)
        {
          //avoid the mouse!!!
          if (MouseTracker.bMouseDown && MouseTracker.mousePos != undefined)
          {
            var mouseDist = particle.position.distance( MouseTracker.mousePos );
            if (mouseDist < particleMouseAvoidanceDist)
            {
              var mouseStr = (particleMouseAvoidanceDist-mouseDist)/particleMouseAvoidanceDist;

              var mouseDir = particle.position.direction(MouseTracker.mousePos);
              mouseDir.multiply( mouseStr * particleMouseAvoidanceStr * GameLoop.deltaTime );
              particle.addForce( mouseDir.x, mouseDir.y );
            }
          }

          // accelerate the particle
          var velocityVector = vectorField[xPos][yPos];
          particle.addForce( velocityVector.x * GameLoop.deltaTime, velocityVector.y * GameLoop.deltaTime );
        }

        // move the particle
        particle.update();
        particle.clampPosition(0,0, activeCanvas.width, activeCanvas.height);

        //draw the particles
        bgCtx.fillRect(particle.position.x, particle.position.y, particle.size, particle.size);
        //bgCtx.fillRect(xPos, yPos, particle.size, particle.size);

        activeCtx.fillStyle = 'hsla('+particleHue+','+theSaturation+'%,98%,1)';
        //activeCtx.fillStyle = 'rgba(255,255,255,1)';
        activeCtx.fillRect(particle.position.x, particle.position.y, particle.size, particle.size);
        //activeCtx.fillRect(xPos, yPos, particle.size, particle.size);
      }

    }

    //------------------------------------------------
    //                    Mouse events
    //------------------------------------------------
    function onMouseDown()
    {

    }

  </script>

</body>
</html>
