<!DOCTYPE html>
<html lang = "en"> <!-- language flag, used by screen readers -->
<head>
  <meta charset = "uft-8" /> <!-- character set definition -->
	<meta name="apple-mobile-web-app-capable" content="yes"> <!-- if the page gets added to homescreen then it will go full screen -->
	<meta name="mobile-web-app-capable" content="yes"> <!-- see http://www.html5rocks.com/en/mobile/fullscreen/ -->

  <title>Josh Newland's page</title>
  <!-- imports  CSS definitions with media queries-->
  <link rel= "stylesheet" href ="styles/layout.css">

</head>
<body>

  <div id="contentContainer" style="height:100%; width:100%; display:contents;">
    <canvas id="bgCanvas" style="display:block; position:absolute; width:100vw; height:100vh;"></canvas>
    <canvas id="activeCanvas" style="display:block; position:absolute; width:100vw; height:100vh;"></canvas>
    <div style="height:100%; width:100%; display:flex; flex-direction:column; position:absolute; align-items:center; justify-content:center;">
      <div id="labelsContainer">
        <!-- <img id="meImage" src="images/me.png" alt="" style="width:150px;height:150px;"> -->

        <p id="headerLabel" >Hi, I'm Josh Newland</p>
        <p id="descriptionLabel" >I'm a software programmer from the UK, mostly focused on games development</p>
        <a href="https://docs.google.com/document/d/1aoY__ax24UL680VNK6I426u9ZPTJPOzOeF7xRY3nEOI/edit?usp=sharing" target="_blank" value=""><input type="button" class="standardButton" value="Check out my CV" /></a>
        <hr class="horizontalLine" id="linksSpacer"/>
        <ul id="linksList">
          <a class="imageLink" title="Email me" href="mailto:joshuanewland33@gmail.com" target="_blank" value=""><img src="images/email.png" class="imageLinkIcon" /></a>
          <a class="imageLink" title="Have a look at my Linkedin" href="https://www.linkedin.com/in/jn327/" target="_blank" value=""><img src="images/linkedin.png" class="imageLinkIcon" /></a>
          <a class="imageLink" title="I'm on Twitter, sometimes" href="https://twitter.com/JoshuaNewland" target="_blank" value=""><img src="images/twitter.png" class="imageLinkIcon" /></a>
          <a class="imageLink" title="My BitBucket page" href="https://bitbucket.org/Jn327/" target="_blank" value=""><img src="images/bitbucket.png" class="imageLinkIcon" /></a>
          <a class="imageLink" title="You can also find me on GitHub" href="https://github.com/jn327" target="_blank" value=""><img src="images/github.png" class="imageLinkIcon" /></a>
          <a class="imageLink" title="I've some games on GameJolt" href="https://gamejolt.com/@Jn327/games" target="_blank" value=""><img src="images/gamejolt.png" class="imageLinkIcon" /></a>
          <a class="imageLink" title="I've got games on Itch.io" href="https://jn327.itch.io/" target="_blank" value=""><img src="images/itchio.png" class="imageLinkIcon" /></a>
        </ul>
      </div>
    </div>
  </div>

  <script src="scripts/Utils/Vector2d.js"></script>
  <script src="scripts/Utils/MathEx.js"></script>
  <script src="scripts/Utils/SimplexNoise.js"></script>
  <script src="scripts/WindowInit.js"></script>

  <script src="scripts/Particle.js"></script>

  <script>

    //HTML Elements
    var bgCanvas, bgCtx;
    var activeCanvas, activeCtx;

    //noise
    var strNoiseScale = 0.002;
    var dirNoiseScale = 0.004;
    var hueNoiseScale = 0.0002;

    var vectorField;
    var hueField;
    var vectorFieldStrMultip = 0.1;

    var pixelSizeX = 4;
    var pixelSizeY = 4;
    var lastPixelX;
    var lastPixelY;

    var particles;
    var particleSize = 3;

    var particleMouseAvoidanceDist = 100;
    var particleMouseAvoidanceStr = 0.005;

    var nParticles = 2500;

    //yellows and oranges tend to look a bit brown, cut them out!
    // see http://colorizer.org/ for the hsla
    var minHue = 80;
    var maxHue = 360;
    var theHue = 0;
    var hueVariation = 40;

    var changeFrequency = 1300;
    var currItteration = 0;
    var fadeDur = 200;
    var fadeItteration = 0;

    //------------------------------------------------
    //                Initialization
    //------------------------------------------------
    function start()
    {
      setRandomHue();

      initCanvas();
      initVectorField();
      initParticles();
    }

    function setRandomHue()
    {
      theHue = (minHue+(hueVariation*0.5)) + (Math.random() * ((maxHue-(minHue))-hueVariation));
    }

    function initCanvas()
    {
      bgCanvas  = document.getElementById("bgCanvas");
      bgCtx     = bgCanvas.getContext('2d');

      activeCanvas = document.getElementById("activeCanvas");
      activeCtx    = activeCanvas.getContext('2d');

      validateCanvasSize();
    }

    function validateCanvasSize()
    {
      var bTrue = false;

      bTrue = updateCanvasSize( bgCanvas );
      bTrue = updateCanvasSize( activeCanvas );

      return bTrue;
    }

    function updateCanvasSize( theCanvas )
    {
      //see http://webglfundamentals.org/webgl/lessons/webgl-anti-patterns.html
      var theW = theCanvas.clientWidth;
      var theH = theCanvas.clientHeight;
      if (theCanvas.width != theW || theCanvas.height != theH)
      {
         theCanvas.width = theW;
         theCanvas.height = theH;

         return true;
      }
      return false;
    }

    function initVectorField()
    {
      var strNoise = new SimplexNoise();
      var dirNoise = new SimplexNoise();
      var hueNoise = new SimplexNoise();

      vectorField = [];
      hueField = [];

      for ( var x = 0; x < bgCanvas.width; x += pixelSizeX )
      {
        lastPixelX = x;
        vectorField[x] = [];
        hueField[x] = [];

        for ( var y = 0; y < bgCanvas.height; y+= pixelSizeY )
        {
          lastPixelY = y;

          var vectorStr = (strNoise.noise(x * strNoiseScale, y * strNoiseScale) + 1) * 0.5; //0-1
          var vectorDir = (dirNoise.noise(x * dirNoiseScale, y * dirNoiseScale) + 1) * Math.PI;
          var hueValue = strNoise.noise(x * hueNoiseScale, y * hueNoiseScale); //-1 to -1

          var theVector = new Vector2D(Math.cos(vectorDir), Math.sin(vectorDir));
          theVector.multiply(vectorStr * vectorFieldStrMultip);
          vectorField[x][y] = theVector;
          hueField[x][y] = hueValue;

          // Background canvas
          var hueWithVar = theHue + (hueValue * hueVariation);
          bgCtx.fillStyle = 'hsla('+hueWithVar+',100%,50%,0.15)';
          bgCtx.fillRect(x,y,pixelSizeX,pixelSizeY);

        }
      }
    }

    function initParticles()
    {
      particles = [];

      var particle;
      for ( var n = 0; n < nParticles; n++ )
      {
        particle = new Particle();
        setupParticle(particle);
        particles[n] = particle;
      }
    }

    function setupParticle(theParticle)
    {
      theParticle.position.x = Math.random() * lastPixelX;
      theParticle.position.y = Math.random() * lastPixelY;
      theParticle.size = particleSize;

      return theParticle;
    }

    function resetParticles()
    {
      for ( var n = 0; n < particles.length; n++ )
      {
        setupParticle(particles[n]);
      }
    }

    //------------------------------------------------
    //                    Update
    //------------------------------------------------
    function update()
    {
      if (validateCanvasSize() == true)
      {
        currItteration = 0;
        fadeItteration = 0;

        resetBgCanvas();
        activeCtx.clearRect(0, 0, activeCanvas.width, activeCanvas.height);

        initVectorField();
        resetParticles();
      }
      else
      {
        currItteration++;
        if (currItteration > changeFrequency)
        {
          if (fadeItteration < fadeDur)
          {
            fadeItteration++;

            var endOpacity = 1 - (fadeItteration/fadeDur);
            bgCanvas.style.opacity = endOpacity;
          }
          else
          {
            currItteration = 0;
            fadeItteration = 0;

            setRandomHue();
            resetBgCanvas();

            //Hacky reset of the vector field after a while, keeps things interesting...
            initVectorField();
          }
        }
      }

      renderCanvas();
    }

    function resetBgCanvas()
    {
      bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
      bgCanvas.style.opacity = 1;
    }

    function renderCanvas()
    {
      activeCtx.clearRect(0, 0, activeCanvas.width, activeCanvas.height);
      bgCtx.fillStyle = 'hsla('+theHue+',100%,60%,0.002)';

      var particle;
      var xPos;
      var yPos;
      for ( var n = 0; n < particles.length; n++ )
      {
        var mouseStr = 0;
        var hueVariance = 0;

        particle = particles[n];

        //Guard against null ref!
        xPos = Math.roundMultip(particle.position.x, pixelSizeX);
        yPos = Math.roundMultip(particle.position.y, pixelSizeY);

        if (xPos >= 0 && yPos >= 0
          && xPos <= lastPixelX && yPos <= lastPixelY)
        {
          //avoid the mouse!!!
          if (_mousePos != undefined)
          {
            var mouseDist = particle.position.distance( _mousePos );
            if (mouseDist < particleMouseAvoidanceDist)
            {
              mouseStr = (particleMouseAvoidanceDist-mouseDist)/particleMouseAvoidanceDist;

              var mouseDir = particle.position.direction(_mousePos);
              mouseDir.multiply( particleMouseAvoidanceStr );
              particle.accelerate( mouseDir.x, mouseDir.y );
            }
          }

          // accelerate the particle
          var velocityVector = vectorField[xPos][yPos];
          particle.accelerate( velocityVector.x, velocityVector.y );

          // move the particle
          particle.position.x += particle.velocity.x;
          particle.position.y += particle.velocity.y;

          //get the hue variance here
          hueVariance = hueField[xPos][yPos];
        }
        else
        {
          if (xPos < 0)
          {
            particle.position.x = lastPixelX;
          }
          if (yPos < 0)
          {
            particle.position.y = lastPixelY;
          }
          if (xPos > lastPixelX)
          {
            particle.position.x = 0;
          }
          if (yPos > lastPixelY)
          {
            particle.position.y = 0;
          }
        }

        var hueAtPos = theHue + (hueVariance * hueVariation);

        //bgCtx.fillRect(particle.position.x, particle.position.y, particle.size, particle.size);
        bgCtx.fillRect(xPos, yPos, particle.size, particle.size);

        activeCtx.fillStyle = 'hsla('+hueAtPos+',100%,' +(75+(mouseStr*25)) +'%,1)';
        //activeCtx.fillRect(particle.position.x, particle.position.y, particle.size, particle.size);
        activeCtx.fillRect(xPos, yPos, particle.size, particle.size);
      }

    }

    //------------------------------------------------
    //                    Events
    //------------------------------------------------
    function onMouseDown()
    {

    }

  </script>

</body>
</html>
